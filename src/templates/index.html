{% extends "layout.html" %}

{% block head %}
<link rel="stylesheet" href="../static/styles/index.css">
{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js" defer></script>
<script src="../static/scripts/index.js" defer></script>
<style>
  .filters { margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; }
  .filter-row { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem; }
  .filter-row select, .filter-row input { padding: 0.35rem; }
  .filter-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
  .remove-filter { background: transparent; border: none; color: #a00; cursor: pointer; font-weight: bold; }
</style>
{% endblock %}

{% block body %}

<h2>Search references</h2>

<form method="get" action="/" class="filters" id="search-form">
  <div>
    <label for="name">Name:</label>
    <input type="text" name="name" id="name" placeholder="Search by name" value="{{ selected_name }}">
  </div>

  <div style="margin-top:0.5rem;">
    <label for="types">Types:</label>
    <select id="types" name="types" multiple>
      {% for t in all_types %}
        <option value="{{ t }}" {% if t in selected_types %}selected{% endif %}>{{ t }}</option>
      {% endfor %}
    </select>
  </div>

<div style="margin-top:0.75rem;">
  <label>Field filters:</label>
  <div id="field-filters" data-all-fields='{{ all_fields | tojson }}'>
    {% if selected_filters and selected_filters|length > 0 %}
      {% for ff in selected_filters %}
        <div class="filter-row">
          <select name="field">
            {% for f in all_fields %}
              <option value="{{ f }}" {% if f == ff.field %}selected{% endif %}>{{ f }}</option>
            {% endfor %}
          </select>
          <select name="op">
            {% set ops = ['contains', 'equals', 'startswith', 'endswith'] %}
            {% for o in ops %}
              <option value="{{ o }}" {% if o == ff.op %}selected{% endif %}>{{ o }}</option>
            {% endfor %}
          </select>
          <input type="text" name="value" value="{{ ff.value }}" placeholder="Value">
          <button type="button" class="remove-filter" aria-label="Remove filter">&times;</button>
        </div>
      {% endfor %}
    {% else %}
    {% endif %}
  </div>

  <div class="filter-actions">
    <button type="button" id="add-field-filter">Add field filter</button>
    <button type="submit">Search</button>
    <a href="/">Clear</a>
  </div>
</div>
</form>

<h2>All references: </h2>

{% if references %}
<ul>
    {% for ref in references %}
    <div>
        <p>{{ref.name}}, type: {{ref.type}} | <a href="/edit_reference?id={{ ref.id }}" class="edit-reference">Edit reference</a></p>
        {% for field in ref.fields %}
            <p>{{field.type}}: {{field.value}}</p>
{% block title %}References{% endblock %}

{% block body %}

{% if refs %}
<div id="refs">
    {% for ref in refs %}
    <a href="/edit-reference?id={{ ref.id }}" class="ref-card">
        <div class="ref-info">
            <p class="ref-type">@{{ ref.type }}</p>
            <p class="ref-key">{{ ref.name }}</p>
            {% if ref.optional_count %}
            <p class="field-count">+{{ ref.optional_count }} fields</p>
            {% else %}
            <p class="field-count">{{ ref.optional_count }} fields</p>
            {% endif %}
        </div>
        <div class="fields">
        {% for field in ref.fields if field.type in ref.required %}
            <div class="field">
                <p class="field-type">{{ field.type }}</p>
                <p class="field-value">{{ field.value }}</p>
            </div>
        {% endfor %}
        </div>
    </a>
    {% endfor %}
</div>
{% else %}
<div id="no-references">
    <p>It's quiet here...</p>
    <p>Get started by creating a reference.</p>
</div>
{% endif %}

{% endblock %}