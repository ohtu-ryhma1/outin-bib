{% extends "layout.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
<link rel="stylesheet" href="../static/styles/index.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js" defer></script>
<script src="../static/scripts/index.js" defer></script>
{% endblock %}

{% block title %}References{% endblock %}

{% block navbar %}
<button id="open-search-button">
    <span id="open-search-icon" class="material-symbols-outlined">search</span>
</button>
{% endblock %}

{% block body %}
<div id="search-overlay">
    <form id="search-form" action="/" method="get">
        <div id="search-form-header">
            <h2 id="search-form-title">Search References</h2>
            <button id="close-search-button" class="icon-button" type="button">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div id="ref-key-search" class="search-block">
            <label class="block-title" for="ref-key">Search by key</label>
            <p class="block-description">Fuzzy search</p>
            {% if key %}
            <input type="text" name="ref-key" id="ref-key" placeholder="key" value="{{ key }}">
            {% else %}
            <input type="text" name="ref-key" id="ref-key" placeholder="key">
            {% endif %}
        </div>

        <div id="ref-type-filter" class="search-block">
            <label class="block-title" for="ref-type">Filter by type</label>
            <p class="block-description">Inclusive OR</p>
            <select id="ref-type" name="ref-type" multiple>
                {% for type in all_ref_types %}
                {% if type in ref_types %}
                <option selected>{{ type }}</option>
                {% else %}
                <option>{{ type }}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>

        <div id="field-search" class="search-block">
            <label class="block-title" for="field-filters">Filter by field</label>
            <p class="block-description">Fuzzy search</p>
            <button id="add-filter-button" type="button">
                <span id="add-filter-icon" class="material-symbols-outlined">add</span>
                Add filter
            </button>
            <div id="field-filters" data-list='{{ all_field_types | tojson }}'>
                {% for field_filter in field_filters %}
                <div class="field-filter">
                    <select name="field-type">
                        {% for field in all_field_types %}
                        {% if field == field_filter[0] %}
                        <option selected>{{ field }}</option>
                        {% else %}
                        <option>{{ field }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                    <input type="text" name="field-value" value="{{ field_filter[1]}}" placeholder="value">
                    <button type="button" class="remove-filter-button">
                        <span class="remove-filter-icon material-symbols-outlined">close</span>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="search-form-controls">
            <a id="reset-search-link" href="/">
                Reset
                <span id="reset-search-icon" class="material-symbols-outlined">replay</span>
            </a>
            <button id="submit-search-button" type="submit">
                Search
                <span id="submit-search-icon" class="material-symbols-outlined">search</span>
            </button>
        </div>
    </form>
</div>

{% if refs %}
<div id="refs">
    {% for ref in refs %}
    <a href="/edit-reference?id={{ ref.id }}" class="ref-card">
        <div class="ref-info">
            <p class="ref-type">@{{ ref.type }}</p>
            <p class="ref-key">{{ ref.key }}</p>
            {% if ref.optional_count %}
            <p class="field-count">+{{ ref.optional_count }} fields</p>
            {% endif %}
        </div>
        <div class="fields">
        {% for field in ref.fields if field.type in ref.required %}
            <div class="field">
                <p class="field-type">{{ field.type }}</p>
                <p class="field-value">{{ field.value }}</p>
            </div>
        {% endfor %}
        </div>
    </a>
    {% endfor %}
</div>
{% else %}
<div id="no-references">
    <p>It's quiet here...</p>
    <p>Get started by creating a reference.</p>
</div>
{% endif %}

{% endblock %}